<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ä¸‰æ æ¨ªå±åŸå‹ Â· ä¸–ç•Œ-å¯¹è¯-æ’è¯</title>
  <style>
    :root {
      --left-bg: rgba(40, 70, 90, 0.25);
      --mid-bg: #1f1f23;
      --right-bg: rgba(160, 90, 20, 0.18);
      --card-bg: rgba(255,255,255,0.06);
      --text-primary: #eee;
      --text-secondary: #bfc7d5;
      --accent-warm: #ffb54a;
      --accent-cool: #6ec1c1;
      --danger: #ff5566;
      --ok: #4dc276;
      --shadow: 0 6px 16px rgba(0,0,0,0.25);
      --radius: 12px;
      --fast: 0.2s;
      --normal: 0.4s;
      --branch: 0.5s;
    }
    html, body { height: 100%; background: #0f1115; color: var(--text-primary); margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "PingFang SC", "Microsoft YaHei", sans-serif; }
    #rotate-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 1000; font-size: 20px; text-align: center; padding: 24px; }

    .app { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 12px; height: 100%; padding: 12px 16px; box-sizing: border-box; }
    .panel { border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; min-height: 0; }

    /* å·¦æ  */
    #world-panel { background: linear-gradient(180deg, var(--left-bg), transparent 65%), radial-gradient(1200px 600px at 0% 0%, rgba(80,120,140,0.25), transparent 60%); }
    #world-events { padding: 12px; overflow: auto; }
    .event-card { background: var(--card-bg); border: 1px solid rgba(160,200,220,0.18); border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; animation: slideIn var(--normal) ease; }
    .event-card.new { box-shadow: 0 0 0 2px rgba(160,200,220,0.45) inset; animation: flash var(--fast) ease-in; }
    .event-time { font-size: 12px; color: var(--text-secondary); }
    .event-title { font-weight: 700; margin: 6px 0 4px; }
    .event-desc { font-size: 14px; color: #d9e2ef; opacity: 0.9; }

    /* ä¸­æ  */
    #chat-panel { background: var(--mid-bg); position: relative; }
    #chat-stream { padding: 56px 12px 12px; overflow: auto; display: flex; flex-direction: column; gap: 10px; }
    .msg { max-width: 76%; padding: 10px 12px; background: #2a2d33; border-radius: 12px; line-height: 1.4; }
    .msg.npc { align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg.player { align-self: flex-end; background: #3b3f47; border-bottom-right-radius: 4px; }
    .msg.branch { outline: 2px dashed rgba(255,181,74,0.5); animation: branch var(--branch) ease; }

    #composer { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px; background: rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.06); }
    #input-text { background: #24272e; color: var(--text-primary); border: 1px solid #3a3f48; border-radius: 8px; padding: 10px; }
    #btn-send, #btn-voice-mini { background: #3a3f48; color: #fff; border: 0; border-radius: 8px; padding: 10px 12px; cursor: pointer; }

    #btn-eagle, #btn-mosquito {
      position: absolute; bottom: 72px; width: 44px; height: 44px; border-radius: 50%; border: 0; cursor: pointer;
      display: grid; place-items: center; box-shadow: var(--shadow);
    }
    #btn-eagle { left: 12px; background: radial-gradient(circle at 30% 30%, #6ec1c1, #244b50); transition: filter var(--fast); }
    #btn-eagle.warning { filter: drop-shadow(0 0 8px #ffb54a) saturate(1.2); }
    #btn-eagle.hostile { filter: drop-shadow(0 0 10px #ff5566) saturate(1.4) brightness(1.2); }
    #btn-mosquito { right: 12px; background: radial-gradient(circle at 70% 30%, #ffb54a, #7a3f18); }

    #chat-pause-overlay { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); z-index: 5; }
    #chat-pause-overlay .wave { width: 72px; height: 16px; background: repeating-linear-gradient(90deg, #fff 0 12px, transparent 12px 16px); opacity: 0.75; animation: pulse 1s infinite ease-in-out; border-radius: 8px; }

    /* HUD å¹²æ‰°åº¦ä¸æŒ‰é’® */
    #hud { position: absolute; top: 8px; left: 12px; right: 12px; display: flex; align-items: center; gap: 12px; z-index: 6; }
    #fate-meter { flex: 1; height: 12px; background: rgba(255,255,255,0.08); border-radius: 999px; position: relative; overflow: hidden; }
    #fate-meter .bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #6ec1c1, #ffb54a 50%, #ff5566); transition: width var(--normal); }
    #fate-meter .tick { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.35); opacity: 0.6; }
    #fate-meter .tick.warn { background: rgba(255,181,74,0.8); }
    #fate-meter .tick.danger { background: rgba(255,85,102,0.9); }
    .hud-btn { padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 8px; cursor: pointer; }

    /* å³æ  */
    #interject-panel { background: linear-gradient(180deg, var(--right-bg), transparent 65%); position: relative; }
    #interject-scroll { padding: 12px; overflow: auto; display: flex; flex-direction: column; gap: 10px; }
    .interject-suggest { text-align: left; background: #3c2f24; color: #ffd59a; border: 1px solid #8a5a2d; border-radius: 10px; padding: 10px 12px; cursor: pointer; }
    .interject-suggest[disabled] { opacity: 0.5; cursor: not-allowed; }
    .interject-suggest:hover:not([disabled]) { filter: brightness(1.05); }

    #voice-area { margin-top: auto; padding: 12px; border-top: 1px solid rgba(255,255,255,0.06); }
    #btn-voice { width: 100%; padding: 14px 12px; border-radius: 12px; border: 2px dashed #cc8844; background: rgba(255,181,74,0.15); color: #ffd59a; cursor: pointer; }
    #btn-voice.recording { border-style: solid; background: rgba(255,85,102,0.15); border-color: var(--danger); }
    #btn-voice[disabled] { opacity: 0.6; cursor: not-allowed; }
    #hint { color: #ffd59a; opacity: 0.8; font-size: 12px; margin-top: 6px; }

    .drawer-toggle { display: none; position: fixed; top: 12px; width: 40px; height: 40px; border-radius: 20px; border: 0; cursor: pointer; z-index: 20; box-shadow: var(--shadow); }
    #toggle-left { left: 12px; background: #25404a; color: #9fd7d7; }
    #toggle-right { right: 12px; background: #6b3a1a; color: #ffd59a; }
    .drawer { position: fixed; top: 0; bottom: 0; width: min(86vw, 360px); background: #111; box-shadow: var(--shadow); transform: translateX(-110%); transition: transform var(--normal); z-index: 15; display: flex; flex-direction: column; }
    .drawer.right { right: 0; left: auto; transform: translateX(110%); }
    .drawer.open.left { transform: translateX(0); }
    .drawer.open.right { transform: translateX(0); }

    /* æ¨¡æ€å±‚ */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); z-index: 50; }
    .modal.open { display: flex; }
    .modal .box { width: min(92vw, 560px); max-height: 76vh; overflow: auto; background: #191b20; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; }
    .modal h3 { margin: 0 0 8px; }
    .evo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .evo-card { background: #262a31; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 12px; cursor: pointer; }
    .evo-card:hover { filter: brightness(1.05); }
    .evo-card.selected { outline: 2px solid #ffb54a; }
    .obj-item { background: #24272e; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 10px; margin-bottom: 8px; }

    /* åŠ¨ç”» */
    @keyframes slideIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes flash { 0% { box-shadow: 0 0 0 0 rgba(160,200,220,0.8) inset; } 100% { box-shadow: 0 0 0 2px rgba(160,200,220,0.45) inset; } }
    @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    @keyframes branch { 0% { transform: scale(1.0); } 35% { transform: scale(1.03); } 100% { transform: scale(1.0); } }

    /* æ–­ç‚¹ä¸é€‚é… */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      #world-panel, #interject-panel { display: none; }
      #toggle-left, #toggle-right { display: block; }
      .drawer { display: flex; }
    }
    @media (min-width: 900px) and (max-width: 1200px) { body { font-size: 17px; } }
    @media (min-width: 1400px) { .app { padding: 16px 32px; gap: 16px; } }
  </style>
</head>
<body>
  <div id="rotate-overlay">æœ¬åŸå‹ä¸æ”¯æŒç«–å±ï¼Œè¯·æ—‹è½¬è®¾å¤‡è‡³æ¨ªå±ä»¥ç»§ç»­ä½“éªŒã€‚</div>
  <button id="toggle-left" class="drawer-toggle" aria-label="æ‰“å¼€ä¸–ç•Œäº‹ä»¶">â˜°</button>
  <button id="toggle-right" class="drawer-toggle" aria-label="æ‰“å¼€æ’è¯åŒº">âœ¦</button>
  <aside id="drawer-left" class="drawer left" aria-hidden="true">
    <header style="padding:12px 12px 0; color:#9fd7d7">ä¸–ç•Œå…³é”®äº‹ä»¶</header>
    <div id="drawer-world" style="padding:12px; overflow:auto"></div>
  </aside>
  <aside id="drawer-right" class="drawer right" aria-hidden="true">
    <header style="padding:12px 12px 0; color:#ffd59a">æ’è¯å»ºè®® & è¯­éŸ³</header>
    <div id="drawer-interject" style="padding:12px; overflow:auto"></div>
  </aside>
  <main class="app" role="application">
    <section id="world-panel" class="panel" aria-label="ä¸–ç•Œå…³é”®äº‹ä»¶">
      <div id="world-events"></div>
    </section>

    <section id="chat-panel" class="panel" aria-label="ç©å®¶å¯¹è¯">
      <div id="hud">
        <div id="fate-meter" title="å¹²æ‰°åº¦">
          <div class="bar"></div>
          <div class="tick warn" style="left:30%"></div>
          <div class="tick warn" style="left:60%"></div>
          <div class="tick danger" style="left:85%"></div>
        </div>
        <button id="btn-objectives" class="hud-btn">ç›®æ ‡</button>
      </div>

      <div id="chat-pause-overlay"><div class="wave" title="è¯­éŸ³å¤„ç†ä¸­â€¦"></div></div>
      <div id="chat-stream"></div>
      <div id="composer">
        <input id="input-text" placeholder="è¾“å…¥ä»¥è·Ÿéšå‘½è¿â€¦ï¼ˆæˆ–å³ä¾§é€‰æ‹©æ’è¯ï¼‰" />
        <button id="btn-voice-mini" title="çŸ­æŒ‰å½•éŸ³">è¯­éŸ³</button>
        <button id="btn-send">å‘é€</button>
      </div>
      <button id="btn-eagle" title="ä¿¯ç°ä¸–ç•Œå±€åŠ¿" aria-label="è€é¹°">ğŸ¦…</button>
      <button id="btn-mosquito" title="å¾®å°æ‰°åŠ¨Â·è¿›åŒ–" aria-label="èšŠå­">ğŸ¦Ÿ</button>
    </section>

    <aside id="interject-panel" class="panel" aria-label="æ’è¯åŒº">
      <div id="interject-scroll"></div>
      <div id="voice-area">
        <button id="btn-voice">é•¿æŒ‰è¯´è¯ä»¥æš‚åœç¾¤èŠ</button>
        <div id="hint">æç¤ºï¼šé•¿æŒ‰æœŸé—´ä¸­æ ä¼šæš‚åœï¼Œè¯†åˆ«ç»“æŸåå¯¹ä¸–ç•Œäº§ç”Ÿç»†å¾®å˜åŒ–</div>
      </div>
    </aside>
  </main>

  <!-- ç›®æ ‡é¢æ¿ -->
  <div id="modal-objectives" class="modal" role="dialog" aria-modal="true" aria-label="ç›®æ ‡">
    <div class="box">
      <h3>é˜¶æ®µç›®æ ‡</h3>
      <div id="objectives-list"></div>
      <div style="text-align:right; margin-top:8px"><button id="close-objectives" class="hud-btn">å…³é—­</button></div>
    </div>
  </div>

  <!-- èšŠå­è¿›åŒ–é¢æ¿ -->
  <div id="modal-evo" class="modal" role="dialog" aria-modal="true" aria-label="è¿›åŒ–">
    <div class="box">
      <h3>èšŠå­è¿›åŒ–</h3>
      <div class="evo-grid">
        <div class="evo-card" data-path="speed">
          <div><b>é€Ÿåº¦</b>ï¼ˆå†·å´ -20%ï¼‰</div>
          <div style="opacity:.8">æ›´é¢‘ç¹æ’è¯</div>
        </div>
        <div class="evo-card" data-path="toxin">
          <div><b>æ¯’æ€§</b>ï¼ˆå½±å“ +20%ï¼‰</div>
          <div style="opacity:.8">æ›´å¼ºæƒ…ç»ªæ³¢åŠ¨</div>
        </div>
        <div class="evo-card" data-path="stealth">
          <div><b>éšåŒ¿</b>ï¼ˆè­¦æˆ’é˜ˆå€¼ +10ï¼‰</div>
          <div style="opacity:.8">æ›´éš¾è§¦å‘è€é¹°æ•Œæ„</div>
        </div>
        <div class="evo-card" data-path="swarm">
          <div><b>ç¾¤èš</b>ï¼ˆå½±å“ +30%ï¼‰</div>
          <div style="opacity:.8">æŒç»­åç§»æ›´ä¹…</div>
        </div>
      </div>
      <div style="text-align:right; margin-top:12px"><button id="close-evo" class="hud-btn">å…³é—­</button></div>
    </div>
  </div>

  <script>
    // API base: if served via file://, assume local backend
    const API_BASE = (location.origin === 'null' || location.protocol === 'file:') ? 'http://localhost:8000' : '';

    async function fetchJSON(path, opts = {}) {
      try {
        const res = await fetch(`${API_BASE}${path}`, { headers: { 'Content-Type': 'application/json' }, ...opts });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) { console.warn('API fallback:', err); return null; }
    }

    function updateOrientationOverlay() {
      const overlay = document.getElementById('rotate-overlay');
      const isPortrait = window.matchMedia('(orientation: portrait)').matches;
      overlay.style.display = isPortrait ? 'flex' : 'none';
    }
    window.addEventListener('resize', updateOrientationOverlay); updateOrientationOverlay();

    const worldEventsRoot = document.getElementById('world-events');
    const chatStream = document.getElementById('chat-stream');
    const interjectRoot = document.getElementById('interject-scroll');

    const sampleEvents = [
      { t: 'ç¬¬ 1 æ—¥Â·æ™¨', title: 'é£æš´è¿œå¤„é…é…¿', desc: 'æ¸”æ°‘æŠ¥å‘Šå¤–æµ·æ°”å‹å¼‚å¸¸ï¼Œæµ·é¸Ÿèšé›†æˆç¾¤ã€‚' },
      { t: 'ç¬¬ 1 æ—¥Â·åˆ', title: 'è¾¹å¢ƒçƒ½çƒŸ', desc: 'å·¡é€»é˜Ÿå‘ç°æœªçŸ¥æ——å¸œçš„æ–¥å€™ï¼Œç–‘ä¼¼è¯•æ¢ã€‚' },
      { t: 'ç¬¬ 1 æ—¥Â·æ˜', title: 'å¸‚é›†ä¸­è¯¡å¼‚ä½é¸£', desc: 'æœ‰äººå£°ç§°å¬è§æŒç»­çš„å—¡å—¡å£°ã€‚' },
    ];

    const chatHistory = [];

    const state = {
      interference: 0, // 0-100
      evo: { path: null, power: 1.0, cd: 1.0, warnBonus: 0 },
      cooldown: { suggestions: false, voice: false },
      objectives: [
        { id: 'obj-1', title: 'èº²å¼€é£æš´çœ¼', done: false },
        { id: 'obj-2', title: 'é¿å…å¼•å‘ææ…Œ', done: false },
        { id: 'obj-3', title: 'è§‚å¯Ÿå¤©ç©ºçš„å½±å­', done: false },
      ],
      tick: { timer: null, periodMs: 25000 }
    };

    function renderEvents(target) {
      target.innerHTML = '';
      for (const ev of sampleEvents) {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
          <div class="event-time">${ev.t}</div>
          <div class="event-title">${ev.title}</div>
          <div class="event-desc">${ev.desc}</div>
        `;
        target.appendChild(card);
      }
    }

    function pushChat(text, role = 'npc', isBranch = false) {
      const m = document.createElement('div');
      m.className = `msg ${role}` + (isBranch ? ' branch' : '');
      m.textContent = text;
      chatStream.appendChild(m);
      chatStream.scrollTop = chatStream.scrollHeight;
      chatHistory.push({ role: role === 'player' ? 'player' : 'npc', content: text });
    }

    function updateHUD() {
      const pct = Math.max(0, Math.min(100, state.interference));
      const bar = document.querySelector('#fate-meter .bar');
      bar.style.width = pct + '%';
      // Eagle reaction visuals
      const eagle = document.getElementById('btn-eagle');
      eagle.classList.toggle('warning', pct >= (30 + state.evo.warnBonus));
      eagle.classList.toggle('hostile', pct >= (85 + state.evo.warnBonus));
    }

    function applyInterference(source, base = 1) {
      // multipliers
      const power = state.evo.power || 1.0;
      const delta = Math.round(base * power * 10) / 10; // one decimal
      state.interference = Math.max(0, Math.min(100, state.interference + delta));
      updateHUD();
      maybeEagleReact();
      maybeObjectiveProgress();
    }

    function maybeEagleReact() {
      const warn1 = 30 + state.evo.warnBonus;
      const warn2 = 60 + state.evo.warnBonus;
      const danger = 85 + state.evo.warnBonus;
      const val = state.interference;
      if (val >= danger) {
        // Counter event
        injectWorldEvent({ t: 'æ­¤åˆ»', title: 'é«˜ç©ºçš„æ³¨è§†', desc: 'ä¸€é˜µå¯’æ„æ è¿‡ï¼Œç¾¤ä½“æƒ…ç»ªè¢«å‹åˆ¶ã€‚' }, true);
      } else if (val >= warn2) {
        // Strong hint
        toast('å¤©ç©ºä¸­ä¼ æ¥ä½é¸£ï¼Œåƒæ˜¯åœ¨è­¦å‘Šã€‚');
      } else if (val >= warn1) {
        // Mild hint
        toast('å½±å­ä¼¼ä¹æ›´è¿‘äº†ä¸€ç‚¹ã€‚');
      }
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed'; el.style.left = '50%'; el.style.top = '12px'; el.style.transform = 'translateX(-50%)';
      el.style.background = 'rgba(0,0,0,0.7)'; el.style.border = '1px solid rgba(255,255,255,0.2)';
      el.style.padding = '8px 12px'; el.style.borderRadius = '8px'; el.style.zIndex = 100; el.style.fontSize = '14px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1800);
    }

    function injectWorldEvent(ev, highlight = false) {
      sampleEvents.unshift(ev);
      const card = document.createElement('div');
      card.className = 'event-card' + (highlight ? ' new' : '');
      card.innerHTML = `<div class="event-time">${ev.t}</div><div class="event-title">${ev.title}</div><div class="event-desc">${ev.desc}</div>`;
      worldEventsRoot.prepend(card);
      syncDrawers();
    }

    async function loadAISuggestions() {
      // cooldown gating for suggestions button states
      const payload = { chat: chatHistory.slice(-10), world_events: sampleEvents.slice(0, 6), n: 4 };
      const data = await fetchJSON('/api/suggestions', { method: 'POST', body: JSON.stringify(payload) });
      const suggestions = data?.suggestions || [
        'ä¹Ÿè®¸æˆ‘ä»¬ä½ä¼°äº†å¤©ç©ºçš„å½±å­â€¦', 'ç­‰ç­‰ï¼Œå…ˆåˆ«è¯´è¯ï¼Œå¬â€”â€”ä½ å¬è§äº†å—ï¼Ÿ', 'å‘ä¸œè½¬ç§»é˜Ÿä¼ï¼Œèº²å¼€é£æš´çœ¼ã€‚', 'æŠŠæ¶ˆæ¯å‹ä¸‹å»ï¼Œå…å¾—å¼•èµ·ææ…Œã€‚'
      ];
      renderAISuggestions(interjectRoot, suggestions);
      syncDrawers();
    }

    function renderAISuggestions(target, list) {
      target.innerHTML = '';
      list.forEach((line) => {
        const b = document.createElement('button');
        b.className = 'interject-suggest';
        b.textContent = line;
        b.addEventListener('click', async () => {
          if (state.cooldown.suggestions) { toast('æ’è¯å†·å´ä¸­â€¦'); return; }
          // Apply interference before/after reply
          applyInterference('suggestion', 1);
          pushChat(line, 'player', true);
          const payload = { chat: chatHistory.slice(-10), world_events: sampleEvents.slice(0, 6), player_message: line };
          const data = await fetchJSON('/api/chat', { method: 'POST', body: JSON.stringify(payload) });
          const reply = data?.reply || 'â€¦â€¦å‘½è¿çš„é½¿è½®ç»§ç»­è½¬åŠ¨ã€‚';
          pushChat(reply, 'npc', false);
          startSuggestionCooldown();
          // refresh suggestion after reply
          loadAISuggestions();
        });
        if (state.cooldown.suggestions) b.setAttribute('disabled','true');
        target.appendChild(b);
      });
    }

    function setButtonsDisabled(root, disabled) {
      root.querySelectorAll('button.interject-suggest').forEach(btn => {
        if (disabled) btn.setAttribute('disabled', 'true'); else btn.removeAttribute('disabled');
      });
    }

    function startSuggestionCooldown() {
      const baseMs = 3000; // 3s
      const ms = Math.max(800, Math.round(baseMs * (state.evo.cd || 1.0)));
      state.cooldown.suggestions = true;
      setButtonsDisabled(interjectRoot, true);
      setTimeout(() => { state.cooldown.suggestions = false; setButtonsDisabled(interjectRoot, false); }, ms);
    }

    function startVoiceCooldown(btn) {
      const baseMs = 6000; // 6s
      const ms = Math.max(1200, Math.round(baseMs * (state.evo.cd || 1.0)));
      btn.setAttribute('disabled', 'true');
      state.cooldown.voice = true;
      setTimeout(() => { btn.removeAttribute('disabled'); state.cooldown.voice = false; }, ms);
    }

    function syncDrawers() {
      const drawerWorld = document.getElementById('drawer-world');
      const drawerInterject = document.getElementById('drawer-interject');
      drawerWorld.innerHTML = worldEventsRoot.innerHTML;
      drawerInterject.innerHTML = interjectRoot.innerHTML + document.getElementById('voice-area').outerHTML;
    }

    // åˆå§‹æ¸²æŸ“ä¸å¯¹è¯
    renderEvents(worldEventsRoot);
    pushChat('ã€ç³»ç»Ÿã€‘ä¸–ç•Œå°½æ”¶çœ¼åº•ã€‚');
    pushChat('ä½ è¿Ÿåˆ°äº†ã€‚é£æš´ä¸ä¼šç­‰äººã€‚', 'npc');
    loadAISuggestions();
    updateHUD();

    // æ–‡æœ¬å‘é€
    const input = document.getElementById('input-text');
    document.getElementById('btn-send').addEventListener('click', async () => {
      const v = input.value.trim(); if (!v) return; input.value = '';
      pushChat(v, 'player');
      applyInterference('text', 0.5);
      const payload = { chat: chatHistory.slice(-10), world_events: sampleEvents.slice(0, 6), player_message: v };
      const data = await fetchJSON('/api/chat', { method: 'POST', body: JSON.stringify(payload) });
      const reply = data?.reply || 'æ˜ç™½ã€‚ä½†é£æš´ä»åœ¨æ¨è¿›ã€‚';
      pushChat(reply, 'npc');
      loadAISuggestions();
    });

    // è¯­éŸ³ï¼ˆå³ä¸‹æŒ‰é’®Â·é•¿æŒ‰ï¼‰
    const btnVoice = document.getElementById('btn-voice');
    const pauseOverlay = document.getElementById('chat-pause-overlay');
    function startRecording() { if (state.cooldown.voice) { toast('è¯­éŸ³å†·å´ä¸­â€¦'); return; } btnVoice.classList.add('recording'); pauseOverlay.style.display = 'flex'; }
    async function stopRecording() {
      if (!btnVoice.classList.contains('recording')) return;
      btnVoice.classList.remove('recording');
      pauseOverlay.style.display = 'none';
      const transcript = 'ï¼ˆä½ çš„ä½è¯­åœ¨é£ä¸­æ‰©æ•£â€¦â€¦ï¼‰';
      pushChat(transcript, 'player', true);
      applyInterference('voice', 2);
      const payload = { transcript, chat: chatHistory.slice(-10), world_events: sampleEvents.slice(0, 6) };
      const data = await fetchJSON('/api/voice', { method: 'POST', body: JSON.stringify(payload) });
      const ev = data?.world_event || { t: 'æ­¤åˆ»', title: 'è¯¡å“å›è¡', desc: 'æ®è¯´å—¡é¸£æ±‡æˆå›å£°å¢™ï¼ŒçŸ­æš‚åœæ»äº†äº‰åµã€‚' };
      injectWorldEvent(ev, true);
      startVoiceCooldown(btnVoice);
      loadAISuggestions();
    }
    btnVoice.addEventListener('mousedown', startRecording);
    btnVoice.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt => btnVoice.addEventListener(evt, stopRecording));
    document.getElementById('btn-voice-mini').addEventListener('click', () => { pushChat('ï¼ˆçŸ­è¯­éŸ³ï¼‰å…ˆæš‚åœä¸€ä¸‹ã€‚', 'player', true); applyInterference('voice-mini', 0.8); });

    // è€é¹°æŒ‰é’®
    document.getElementById('btn-eagle').addEventListener('click', () => {
      alert('è€é¹°ï¼šä¿¯ç°ä¸–ç•Œå±€åŠ¿\n\nåŠ¿åŠ›èŒƒå›´ï¼šåŒ—å¢ƒâ†‘ï¼Œè¾¹å¢ƒç´§å¼ åº¦ï¼šä¸­â†’é«˜\nï¼ˆå¹²æ‰°åº¦é«˜æ—¶ï¼Œå¯èƒ½è§¦å‘ååˆ¶äº‹ä»¶ï¼‰');
    });

    // èšŠå­æŒ‰é’® â†’ æ‰“å¼€è¿›åŒ–é¢æ¿
    const modalEvo = document.getElementById('modal-evo');
    document.getElementById('btn-mosquito').addEventListener('click', () => { modalEvo.classList.add('open'); });
    document.getElementById('close-evo').addEventListener('click', () => { modalEvo.classList.remove('open'); });
    modalEvo.querySelectorAll('.evo-card').forEach(card => {
      card.addEventListener('click', () => {
        modalEvo.querySelectorAll('.evo-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        const path = card.getAttribute('data-path');
        state.evo.path = path;
        // reset
        state.evo.power = 1.0; state.evo.cd = 1.0; state.evo.warnBonus = 0;
        if (path === 'speed') state.evo.cd = 0.8;
        if (path === 'toxin') state.evo.power = 1.2;
        if (path === 'stealth') state.evo.warnBonus = 10;
        if (path === 'swarm') state.evo.power = 1.3;
        toast('è¿›åŒ–å·²åº”ç”¨');
      });
    });

    // ç›®æ ‡é¢æ¿
    const modalObj = document.getElementById('modal-objectives');
    const listObj = document.getElementById('objectives-list');
    function renderObjectives() {
      listObj.innerHTML = '';
      state.objectives.forEach(o => {
        const div = document.createElement('div');
        div.className = 'obj-item';
        div.innerHTML = `<b>${o.title}</b><div style="opacity:.75; font-size:13px;">${o.done ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</div>`;
        listObj.appendChild(div);
      });
    }
    function maybeObjectiveProgress() {
      // ç®€å•ç¤ºä¾‹ï¼šå½“å¹²æ‰°åº¦ < 40 æ—¶â€œé¿å…å¼•å‘ææ…Œâ€æ›´æ˜“å®Œæˆï¼›>60 æ—¶â€œè§‚å¯Ÿå½±å­â€å®Œæˆ
      const v = state.interference;
      const o2 = state.objectives.find(o => o.id === 'obj-2');
      const o3 = state.objectives.find(o => o.id === 'obj-3');
      if (v < 40 && o2 && !o2.done) { o2.done = true; toast('ç›®æ ‡å®Œæˆï¼šé¿å…å¼•å‘ææ…Œ'); renderObjectives(); }
      if (v > 60 && o3 && !o3.done) { o3.done = true; toast('ç›®æ ‡å®Œæˆï¼šè§‚å¯Ÿå¤©ç©ºçš„å½±å­'); renderObjectives(); }
    }
    document.getElementById('btn-objectives').addEventListener('click', () => { renderObjectives(); modalObj.classList.add('open'); });
    document.getElementById('close-objectives').addEventListener('click', () => { modalObj.classList.remove('open'); });

    // å®šæ—¶ä¸–ç•Œäº‹ä»¶ï¼ˆå‘½è¿è‡ªæµï¼‰
    function startTicker() {
      if (state.tick.timer) clearInterval(state.tick.timer);
      state.tick.timer = setInterval(() => {
        // è‹¥å¤„äºè¯­éŸ³æš‚åœï¼Œå»¶å
        if (document.getElementById('chat-pause-overlay').style.display === 'flex') return;
        const high = state.interference >= (60 + state.evo.warnBonus);
        const ev = high ?
          { t: 'æµå…‰', title: 'é˜´å½±å‹å¢ƒ', desc: 'å¤©è‰²å¿½æš—ï¼Œè¿œå¤„é¸Ÿç¾¤ç›˜æ—‹ä¸æ•£ã€‚' } :
          { t: 'æµå…‰', title: 'é£å‘å¾®è½¬', desc: 'æœ‰äººè¯´ç©ºæ°”å‹å¾—è€³è†œå‘ç´§ã€‚' };
        injectWorldEvent(ev, false);
        // å°å¹…è‡ªç„¶å›è°ƒå¹²æ‰°åº¦
        state.interference = Math.max(0, state.interference - (high ? 1 : 2));
        updateHUD();
      }, state.tick.periodMs);
    }
    startTicker();

    // æ‰‹æœºæ¨ªå±ï¼šæŠ½å±‰å¼€å…³
    const drawerLeft = document.getElementById('drawer-left');
    const drawerRight = document.getElementById('drawer-right');
    document.getElementById('toggle-left').addEventListener('click', () => { drawerLeft.classList.toggle('open'); drawerLeft.classList.toggle('left'); drawerLeft.setAttribute('aria-hidden', String(!drawerLeft.classList.contains('open'))); });
    document.getElementById('toggle-right').addEventListener('click', () => { drawerRight.classList.toggle('open'); drawerRight.classList.toggle('right'); drawerRight.setAttribute('aria-hidden', String(!drawerRight.classList.contains('open'))); });
  </script>
</body>
</html>